<!DOCTYPE html>
<html lang="ru">
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <title>SportGate Tap Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      touch-action: manipulation;
      font-family: sans-serif;
      background-color: #008000;
    }

    #score, #title {
      position: absolute;
      left: 20px;
      z-index: 10;
      color: white;
      text-shadow: 1px 1px 4px black;
      user-select: none;
    }

    #score {
      top: 40px;
      font-size: 24px;
      font-weight: bold;
    }

    #title {
      top: 10px;
      font-size: 20px;
      font-weight: bold;
      color: #ffffff;
    }

    #gameCanvas {
      position: absolute;
      top: 0;
      left: 0;
      display: block;
    }
	
#soundButton {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 100;
  padding: 8px 15px;
  background: linear-gradient(145deg, #2E8B57, #3CB371);
  border: 2px solid #FFFFFF;
  border-radius: 25px;
  font-weight: bold;
  color: white;
  font-size: 14px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
}

#soundButton:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
}
  </style>
</head>
<body>
  <div id="title">Player SportGate.io</div>
  <div id="score">Tokens: 0</div>
  <canvas id="gameCanvas"></canvas>
  <button id="soundButton">Sound</button>

  <script>
    window.onload = () => {
      const tg = window.Telegram.WebApp;
      tg.ready(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
      const user = tg.initDataUnsafe.user;
      if (user) {
        const username = user.username || `${user.first_name} ${user.last_name || ''}`;
        document.getElementById("title").textContent = `Player: ${username}`;
		
		// === –ó–ê–ì–†–£–ó–öA –°–û–•–†–ê–ù–ï–ù–ù–û–ì–û –°–ß–ï–¢–ê ===
		gameUsername = username; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		const savedScore = await getPlayerScore(username);
		score = savedScore;
		document.getElementById("score").textContent = "Tokens: " + score;
		// =============================================

		
      }
	  
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

  const API_BASE_URL = 'http://45.14.49.71:3000';
  let lastSaveTime = 0;
  let gameUsername = '';
  let needToSave = false;

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—á–µ—Ç–∞
async function getPlayerScore(username) {
  try {
    const response = await fetch(`${API_BASE_URL}/balance/${username}`);
    if (response.status === 404) return 0;
    const data = await response.json();
    return data.balance || 0;
  } catch (error) {
    console.log('Error getting score:', error);
    return 0;
  }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á–µ—Ç–∞
async function setPlayerScore(username, score) {
  try {
    const response = await fetch(`${API_BASE_URL}/balance/${username}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: score })
    });
    console.log('Score saved successfully');
  } catch (error) {
    console.log('Error saving score:', error);
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function scheduleScoreSave() {
  needToSave = true;
}

// --- HOWLER.JS –ê–£–î–ò–û –°–ò–°–¢–ï–ú–ê –° –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–ï–ú ---
let soundsEnabled = false;
let goalSound, saveSound, backgroundMusic;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫–∏ —Å—Ä–∞–∑—É
goalSound = new Howl({
  src: ['goal_sound.ogg'],
  preload: true,
  volume: 0.4,
  html5: true
});

saveSound = new Howl({
  src: ['save_sound.ogg'],
  preload: true, 
  volume: 0.4,
  html5: true
});

backgroundMusic = new Howl({
  src: ['background_music.ogg'], // OGG —Ñ–æ—Ä–º–∞—Ç
  preload: true,
  volume: 0.6, // –º—É–∑—ã–∫–∞ —Ç–∏—à–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
  loop: true,
  html5: true
});

Howler.mute(true);

// –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
const soundButton = document.getElementById('soundButton');
soundButton.textContent = 'üîá';

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞
soundButton.addEventListener('click', () => {
  soundsEnabled = !soundsEnabled;
  
  if (soundsEnabled) {
    Howler.mute(false);
    soundButton.textContent = 'üîä';
	
	// –ï—Å–ª–∏ –º—É–∑—ã–∫–∞ –µ—â–µ –Ω–µ –∏–≥—Ä–∞–µ—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–µ
    if (!backgroundMusic.playing()) {
      backgroundMusic.play();
    }

  } else {
    Howler.mute(true);
    soundButton.textContent = 'üîá';
  }
});

// –§—É–Ω–∫—Ü–∏–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
function playGoalSound() {
  const now = Date.now();
  
  if (soundsEnabled && goalSound && now - lastGoalSoundTime > GOAL_SOUND_COOLDOWN) {
    goalSound.play();
	lastGoalSoundTime = now;
  }
}

function playSaveSound() {
  const now = Date.now();
  
  if (soundsEnabled && saveSound && now - lastSaveSoundTime > SAVE_SOUND_COOLDOWN) {
    saveSound.play();
	lastSaveSoundTime = now;
  }
}

	  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞—á–∞
	  canvas.addEventListener("touchstart", () => {
	    lastTouchTime = Date.now();
	    showIdleCircle = false;
	  });
	  
	  canvas.addEventListener("mousedown", () => {
	    lastTouchTime = Date.now();
	    showIdleCircle = false;
	  });

	  // --- –°–ò–°–¢–ï–ú–ê –ó–ê–î–ï–†–ñ–ö–ò –ó–í–£–ö–û–í –° –†–ê–ó–î–ï–õ–¨–ù–´–ú–ò –ù–ê–°–¢–†–û–ô–ö–ê–ú–ò ---
	  let lastGoalSoundTime = 0;
	  let lastSaveSoundTime = 0;
	  const GOAL_SOUND_COOLDOWN = 100; // 0.1 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –≥–æ–ª–∞
	  const SAVE_SOUND_COOLDOWN = 100; // 0.15 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å–µ–π–≤–∞


      let score = 0;
	  let idlePulse = 0;
	  let jumpOffset = 0;
	  let armOffset = 0;
	  let legOffset = 0;
	  let sadTimer = 0
	  let lastTouchTime = Date.now();
	  let showIdleCircle = false;
	  const flameParticles = [];
	  const floatingTexts = [];
	  const fireworks = [];
      const balls = [];
      const goal = {};
      const goalkeeper = {};
	  
	  const MAX_FIREWORKS = 20; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–≤
	  const MAX_FLAME_PARTICLES = 30; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü –ø–ª–∞–º–µ–Ω–∏
	  const MAX_FLOATING_TEXTS = 15; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–æ–≤

      function resizeCanvas() {
        canvas.width = document.documentElement.clientWidth;
        canvas.height = document.documentElement.clientHeight;
		
		const scoreDisplay = document.getElementById("score");
		const scoreRect = scoreDisplay.getBoundingClientRect();
		
		// –í–æ—Ä–æ—Ç–∞
        goal.x = canvas.width / 2 - 200;
        goal.y = scoreRect.bottom + 85; // 85 –ø–∏–∫—Å–µ–ª–µ–π –Ω–∏–∂–µ –æ—á–∫–æ–≤
        goal.width = 400;
        goal.height = 40;
		
        goalkeeper.radius = 18;
        goalkeeper.x = canvas.width / 2 - 15;
        goalkeeper.y = goal.y + goal.height + 10;
        goalkeeper.speedX = 1.5;
        goalkeeper.direction = 1;

		

      }

      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Å—Ç–∏—Ü –ø–ª–∞–º–µ–Ω–∏
function createFlameParticles(ball) {

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —á–∞—Å—Ç–∏—Ü –ø–ª–∞–º—è–Ω–∏
  if (flameParticles.length >= MAX_FLAME_PARTICLES) {
    return;
  }

  for (let i = 0; i < 1; i++) { // –°–æ–∑–¥–∞–µ–º 3 —á–∞—Å—Ç–∏—Ü—ã –∑–∞ –∫–∞–¥—Ä
    flameParticles.push({
      x: ball.x + Math.random() * 10 - 5,
      y: ball.y + ball.radius,
      size: 5 + Math.random() * 8,
      speed: 2 + Math.random() * 3,
      angle: Math.PI / 2 + (Math.random() * 0.4 - 0.2), // –í –æ—Å–Ω–æ–≤–Ω–æ–º –≤–Ω–∏–∑
      life: 1,
      color: "rgb(255, 255, 255)" // –û—Ä–∞–Ω–∂–µ–≤–æ-–∂–µ–ª—Ç—ã–µ —Ü–≤–µ—Ç–∞
    });
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü –ø–ª–∞–º–µ–Ω–∏
function updateFlameParticles() {
  for (let i = flameParticles.length - 1; i >= 0; i--) {
    const particle = flameParticles[i];
    
    particle.x += Math.cos(particle.angle) * particle.speed;
    particle.y += Math.sin(particle.angle) * particle.speed;
    particle.life -= 0.08; // –≤—Ä–µ–º—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
    particle.size -= 0.15;
    
    if (particle.life <= 0 || particle.size <= 0) {
      flameParticles.splice(i, 1);
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–∏—Ü –ø–ª–∞–º–µ–Ω–∏
function drawFlameParticles() {
  flameParticles.forEach(particle => {
    ctx.save();
    ctx.globalAlpha = particle.life * 0.7;
    
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ø–ª–∞–º–µ–Ω–∏
ctx.fillStyle = particle.color;
    ctx.beginPath();
    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.restore();
  });
}
	  
function spawnBall(event) {
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞–∂–∞—Ç–∏—è
  let clientX, clientY;
  
  if (event.type === 'touchstart') {
    clientX = event.touches[0].clientX;
    clientY = event.touches[0].clientY;
  } else {
    clientX = event.clientX;
    clientY = event.clientY;
  }
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ—á–∫—É –≤—ã—Å—Ç—Ä–µ–ª–∞ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç—å—é —ç–∫—Ä–∞–Ω–∞ (–Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞)
  const minY = canvas.height * 0.7; // 70% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
  const spawnY = Math.max(clientY, minY);
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ—á–∫—É –≤—ã—Å—Ç—Ä–µ–ª–∞ —à–∏—Ä–∏–Ω–æ–π –≤–æ—Ä–æ—Ç
  const minX = goal.x + 20; // –Ω–µ–º–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞–µ–º –æ—Ç –∫—Ä–∞—è –≤–æ—Ä–æ—Ç
  const maxX = goal.x + goal.width - 20;
  const spawnX = Math.min(Math.max(clientX, minX), maxX);
  
  // –°–æ–∑–¥–∞–µ–º –º—è—á –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
  balls.push({
    x: spawnX,
    y: spawnY,
    radius: 20,
    speedY: -10,
    angle: 0,
    active: true
  });
}

canvas.addEventListener("click", function(event) {
  event.preventDefault();
  spawnBall(event);
  lastTouchTime = Date.now();
  showIdleCircle = false;
});

canvas.addEventListener("touchstart", function(event) {
  event.preventDefault();
  spawnBall(event);
  lastTouchTime = Date.now();
  showIdleCircle = false;
});

function spawnFloatingText(text, x, y, color = "white") {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
  if (floatingTexts.length >= MAX_FLOATING_TEXTS) {
    // –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞
    floatingTexts.shift();
  }

  floatingTexts.push({
    text,
    x,
    y,
    alpha: 1,
    dy: -1.5, // —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü —Ç–µ–∫—Å—Ç–∞
    color
  });
}

function updateFloatingTexts() {
  for (let i = floatingTexts.length - 1; i >= 0; i--) {
    const t = floatingTexts[i];
    t.y += t.dy;
    t.alpha -= 0.03; // —Å–∫–æ—Ä–æ—Å—Ç—å –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü —Ç–µ–∫—Å—Ç–∞
    if (t.alpha <= 0) {
      floatingTexts.splice(i, 1);
    }
  }
}

function drawFloatingTexts() {
  floatingTexts.forEach(t => {
    ctx.save();
    ctx.font = "bold 36px sans-serif";
    ctx.fillStyle = t.color;
    ctx.globalAlpha = t.alpha;

    // –î–æ–±–∞–≤–∏–º –ª—ë–≥–∫—É—é —Ç–µ–Ω—å
    ctx.shadowColor = "black";
    ctx.shadowBlur = 4;

    ctx.fillText(t.text, t.x, t.y);

    // –°–±—Ä–æ—Å —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    ctx.globalAlpha = 1;
    ctx.shadowBlur = 0;
    ctx.restore();
  });
}

function colorToRGB(color) {
  const tempCanvas = document.createElement("canvas");
  const tempCtx = tempCanvas.getContext("2d");
  tempCtx.fillStyle = color;
  const rgb = tempCtx.fillStyle.match(/\d+/g).slice(0, 3);
  return rgb.join(",");
}

function spawnFirework(x, y) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏ –ª–∏–º–∏—Ç
  if (fireworks.length >= MAX_FIREWORKS) {
    return; // –ù–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫
  }

  for (let i = 0; i < 20; i++) { // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü –≤ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–µ
    fireworks.push({
      x: x,
      y: y,
      radius: 2 + Math.random() * 3,
      angle: Math.random() * 2 * Math.PI,
      speed: 2 + Math.random() * 4,
      alpha: 1,
      color: getBrightColor()
    });
  }
}

function getBrightColor() {
  const colors = [
    "rgb(255, 255, 255)", // –±–µ–ª—ã–π
    "rgb(255, 255, 0)",   // –∂—ë–ª—Ç—ã–π
    "rgb(0, 191, 255)",   // –≥–æ–ª—É–±–æ–π
    "rgb(255, 105, 180)", // —Ä–æ–∑–æ–≤—ã–π
    "rgb(0, 255, 0)"      // –∑–µ–ª—ë–Ω—ã–π
  ];
  return colors[Math.floor(Math.random() * colors.length)];
}

function updateFireworks() {
  for (let i = fireworks.length - 1; i >= 0; i--) {
    const p = fireworks[i];
    p.x += Math.cos(p.angle) * p.speed;
    p.y += Math.sin(p.angle) * p.speed;
    p.alpha -= 0.03; // –≤—Ä–µ–º—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–≤
    if (p.alpha <= 0) {
      fireworks.splice(i, 1);
    }
  }
}

function drawFireworks() {
  fireworks.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
    ctx.fillStyle = `${p.color.replace("rgb", "rgba").replace(")", `, ${p.alpha})`)}`;
    ctx.fill();
  });
}

function getRandomPlusColor() {
  const colors = [
    "rgb(255, 255, 255)", // –±–µ–ª—ã–π
    "rgb(255, 255, 0)",   // –∂—ë–ª—Ç—ã–π
    "rgb(0, 191, 255)",   // –≥–æ–ª—É–±–æ–π
    "rgb(144, 238, 144)"  // —Å–∞–ª–∞—Ç–æ–≤—ã–π (light green)
  ];
  return colors[Math.floor(Math.random() * colors.length)];
}

function hslToRgb(hslColor) {
  const tempCanvas = document.createElement("canvas");
  const tempCtx = tempCanvas.getContext("2d");
  tempCtx.fillStyle = hslColor;
  const rgb = tempCtx.fillStyle.match(/\d+/g).slice(0, 3);
  return rgb.join(",");
}

function drawFieldStripes() {
  const stripeCount = 7; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–æ—Å
  const stripeWidth = canvas.width / stripeCount;
  const colors = ["#2E8B57", "#3CB371"]; // –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∑–µ–ª—ë–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏

  for (let i = 0; i < stripeCount; i++) {
    ctx.fillStyle = colors[i % 2];
    ctx.fillRect(i * stripeWidth, 0, stripeWidth, canvas.height);
  }
}

function drawGoal() {
  const postWidth = 8;
  const postHeight = goal.height + 50;
  const crossbarHeight = 8;

  // –¶–≤–µ—Ç –≤–æ—Ä–æ—Ç
  ctx.fillStyle = "#FFFFFF";
  ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
  ctx.shadowBlur = 4;

  // –°—Ç–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω—ã
  ctx.fillRect(goal.x, goal.y - postHeight, postWidth, postHeight + 50);
  ctx.fillRect(goal.x + goal.width - postWidth, goal.y - postHeight, postWidth, postHeight + 50);
  ctx.fillRect(goal.x, goal.y - postHeight, goal.width, crossbarHeight);
  ctx.fillRect(goal.x, goal.y + goal.height - crossbarHeight + postWidth + 1, goal.width, crossbarHeight);

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–Ω—å
  ctx.shadowColor = "transparent";
  ctx.shadowBlur = 0;

  // –ü–†–û–°–¢–ê–Ø –ò –≠–§–§–ï–ö–¢–ò–í–ù–ê–Ø –°–ï–¢–ö–ê
  ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
  ctx.lineWidth = 1;
  const gridSize = 10;
  
  // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (–æ—Ç –Ω–∏–∑–∞ –¥–æ –≤–µ—Ä—Ö–∞ –≤–æ—Ä–æ—Ç)
  for (let x = goal.x + 5; x <= goal.x + goal.width - 5; x += gridSize) {
    ctx.beginPath();
    ctx.moveTo(x, goal.y + goal.height - crossbarHeight);
    ctx.lineTo(x, goal.y - postHeight + crossbarHeight);
    ctx.stroke();
  }
  
  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (–ø–æ –≤—Å–µ–π —à–∏—Ä–∏–Ω–µ –≤–æ—Ä–æ—Ç)
  for (let y = goal.y - postHeight + crossbarHeight; y <= goal.y + goal.height - crossbarHeight; y += gridSize) {
    ctx.beginPath();
    ctx.moveTo(goal.x + 5, y);
    ctx.lineTo(goal.x + goal.width - 5, y);
    ctx.stroke();
  }

  // –û–±–≤–æ–¥–∫–∞ –≤–æ—Ä–æ—Ç
  ctx.strokeStyle = "#E8E8E8";
  ctx.lineWidth = 2;
  ctx.strokeRect(goal.x + 1, goal.y, goal.width - 2, goal.height);
}

function drawGoalkeeper() {
  ctx.save();
  ctx.translate(0, jumpOffset); // –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä—ã–∂–∫–∞
  const skinColor = "#FFDAB9"; // –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π
  const jerseyColor = "#1E90FF"; // —è—Ä–∫–∏–π –¥–æ–¥–∂–µ—Ä—Å-—Å–∏–Ω–∏–π
  const shortsColor = "#000080"; // —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π
  const glovesColor = "#FF4500"; // –æ—Ä–∞–Ω–∂–µ–≤–æ-–∫—Ä–∞—Å–Ω—ã–µ –ø–µ—Ä—á–∞—Ç–∫–∏

  // –¢–ï–ù–¨ –ü–û–î –í–†–ê–¢–ê–†–ï–ú
  ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
  ctx.beginPath();
  ctx.ellipse(goalkeeper.x, goalkeeper.y + 55, 15, 5, 0, 0, Math.PI * 2);
  ctx.fill();


  // –ú–∞–π–∫–∞ (–≤–µ—Ä—Ö —Ç—É–ª–æ–≤–∏—â–∞)
  ctx.fillStyle = jerseyColor;
  ctx.fillRect(goalkeeper.x - 10, goalkeeper.y, 20, 25);
  ctx.font = "bold 16px sans-serif";
  ctx.fillStyle = "white";
  ctx.textAlign = "center";
  ctx.fillText("1", goalkeeper.x, goalkeeper.y + 18);
  
  // –®–æ—Ä—Ç—ã
  ctx.fillStyle = shortsColor; 
  ctx.fillRect(goalkeeper.x - 10, goalkeeper.y + 25, 20, 15);
  
  // –ì–æ–ª–æ–≤–∞
  ctx.beginPath();
  ctx.arc(goalkeeper.x, goalkeeper.y - 10, 12, 0, Math.PI * 2);
  ctx.fillStyle = skinColor;
  ctx.fill();

  // –ì–ª–∞–∑–∞
  ctx.beginPath();
  ctx.arc(goalkeeper.x - 5, goalkeeper.y - 23, 5, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();
  ctx.beginPath();
  ctx.arc(goalkeeper.x - 5, goalkeeper.y - 23, 1.5, 0, Math.PI * 2);
  ctx.fillStyle = "black";
  ctx.fill();

  ctx.beginPath();
  ctx.arc(goalkeeper.x + 5, goalkeeper.y - 23, 5, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();
  ctx.beginPath();
  ctx.arc(goalkeeper.x + 5, goalkeeper.y - 23, 1.5, 0, Math.PI * 2);
  ctx.fillStyle = "black";
  ctx.fill();

  // –†—É–∫–∏
  ctx.fillStyle = skinColor;
  ctx.fillRect(goalkeeper.x - 25, goalkeeper.y + 5 + armOffset, 15, 8); // –ª–µ–≤–∞—è
  ctx.fillRect(goalkeeper.x + 10, goalkeeper.y + 5 + armOffset, 15, 8); // –ø—Ä–∞–≤–∞—è

  // –ü–µ—Ä—á–∞—Ç–∫–∏
  ctx.beginPath();
  ctx.arc(goalkeeper.x - 30, goalkeeper.y + 9 + armOffset, 6, 0, Math.PI * 2);
  ctx.fillStyle = glovesColor;
  ctx.fill();

  ctx.beginPath();
  ctx.arc(goalkeeper.x + 30, goalkeeper.y + 9 + armOffset, 6, 0, Math.PI * 2);
  ctx.fillStyle = glovesColor;
  ctx.fill();

  // –ù–æ–≥–∏
  ctx.fillStyle = skinColor;
  ctx.fillRect(goalkeeper.x - 8, goalkeeper.y + 40 + legOffset, 6, 10);
  ctx.fillRect(goalkeeper.x + 2, goalkeeper.y + 40 - legOffset, 6, 10);

  // –ë—É—Ç—Å—ã
  ctx.fillStyle = "#8B4513";
  ctx.fillRect(goalkeeper.x - 8, goalkeeper.y + 50 + legOffset, 6, 5);
  ctx.fillRect(goalkeeper.x + 2, goalkeeper.y + 50 - legOffset, 6, 5);
  
  // –≠–º–æ—Ü–∏–∏ ‚Äî —Ä–æ—Ç
  if (sadTimer > 0) {
    ctx.beginPath();
    ctx.arc(goalkeeper.x, goalkeeper.y - 5, 6, Math.PI, 2 * Math.PI); // –≥—Ä—É—Å—Ç–Ω—ã–π —Ä–æ—Ç
    ctx.strokeStyle = "#2F4F4F";
    ctx.lineWidth = 2;
    ctx.stroke();
    sadTimer--;
  } else {
    ctx.beginPath();
    ctx.arc(goalkeeper.x, goalkeeper.y - 15, 6, 0, Math.PI); // —É–ª—ã–±–∫–∞
    ctx.strokeStyle = "#2F4F4F";
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  ctx.restore();
}
      function updateGoalkeeper() {
	    const baseSpeed = 2.5;
        goalkeeper.x += goalkeeper.speedX * goalkeeper.direction;
        if ( goalkeeper.x + goalkeeper.radius > goal.x + goal.width ) { 
		  goalkeeper.direction = -1;
		} else if (goalkeeper.x - goalkeeper.radius < goal.x) {
		  goalkeeper.direction = 1;
		} else {
		  const randomDirection = Math.random();
		  if (randomDirection < 0.01) {
		    goalkeeper.direction = -1; // 40% chance –≤–ª–µ–≤–æ
		  } else if (randomDirection > 0.99 ) {
		    goalkeeper.direction = 1; // 40% chance –≤–ø—Ä–∞–≤–æ
		  }
		}
		
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
		goalkeeper.speedX = baseSpeed + (Math.random() * 1.5 - 0.75);

		jumpOffset = Math.sin(Date.now() / 200) * 5; // –ø–ª–∞–≤–Ω–æ–µ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–µ
		armOffset = Math.sin(Date.now() / 300) * 4; // –ø–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑
		legOffset = Math.sin(Date.now() / 250) * 3; // –ø–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–æ–≥
      }

      function drawHexagon(ctx, x, y, size) {
        const offset = Math.PI / 6;
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
          const angle = offset + i * Math.PI / 3;
          const px = x + size * Math.cos(angle);
          const py = y + size * Math.sin(angle);
          i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
        }
        ctx.closePath();
        ctx.fill();
      }

function drawBall(ball) {
  // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã —Å–ª–µ–¥–∞ (–û–°–¢–ê–í–õ–Ø–ï–ú)
  if (ball.active && ball.speedY < 0) {
    createFlameParticles(ball);
  }
  
  // –†–∏—Å—É–µ–º –æ–±—ã—á–Ω—ã–π –º—è—á –ë–ï–ó –ø–ª–∞–º–µ–Ω–∏ –≤–æ–∫—Ä—É–≥ (–£–ë–ò–†–ê–ï–ú –ø–ª–∞–º—è)
  ctx.save();
  ctx.translate(ball.x, ball.y);
  ctx.rotate(ball.angle);
  
  // –ü—Ä–æ—Å—Ç–æ –º—è—á –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–ª–∞–º–µ–Ω–∏
  ctx.beginPath();
  ctx.fillStyle = "white";
  ctx.arc(0, 0, ball.radius, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = "black";
  ctx.stroke();

  ctx.fillStyle = "black";
  drawHexagon(ctx, -7, -7, 6);
  drawHexagon(ctx, 8, -5, 6);
  drawHexagon(ctx, 0, 9, 6);

  ctx.restore();
}

      function updateBalls() {
        for (let i = balls.length - 1; i >= 0; i--) {
          const ball = balls[i];
          if (ball.active) {
            ball.y += ball.speedY;
            ball.angle += 0.1;

            const dx = ball.x - goalkeeper.x;
            const dy = ball.y - goalkeeper.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < ball.radius + goalkeeper.radius) {
			  playSaveSound();
			  const randX = goal.x + 20 + Math.random() * (goal.width - 40); // –≤–Ω—É—Ç—Ä–∏ —à–∏—Ä–∏–Ω—ã –≤–æ—Ä–æ—Ç
			  const randY = goal.y + goal.height + 30; 
			  spawnFloatingText("X", randX, randY, "#ff4444"); // –∫—Ä–∞—Å–Ω—ã–π
              ball.active = false;
              balls.splice(i, 1);
              continue;
            }

            if (
              ball.y - ball.radius < goal.y + goal.height &&
              ball.x > goal.x &&
              ball.x < goal.x + goal.width
            ) {
			  playGoalSound();
			  spawnFirework(ball.x, goal.y + goal.height / 2);
			  const randX = goal.x + 20 + Math.random() * (goal.width - 40); // –≤–Ω—É—Ç—Ä–∏ –≤–æ—Ä–æ—Ç, —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º
			  const randY = Math.random() * canvas.height * 0.6; // –≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞
			  spawnFloatingText("+1", randX, randY, getRandomPlusColor());
			  sadTimer = 60; // –≥—Ä—É—Å—Ç–∏—Ç 60 –∫–∞–¥—Ä–æ–≤
              score += 1;
              document.getElementById("score").textContent = "Tokens: " + score;
			  scheduleScoreSave(); // –ü—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
              ball.active = false;
              balls.splice(i, 1);
            } else if (ball.y + ball.radius < 0) {
              ball.active = false;
              balls.splice(i, 1);
            }
          }
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
		drawFieldStripes();
		updateFlameParticles();
		drawFlameParticles();
		drawFloatingTexts();
		updateFloatingTexts();
		drawFireworks();
		updateFireworks();
        drawGoal();
        drawGoalkeeper();
        balls.forEach(drawBall);
        updateBalls();
        updateGoalkeeper();
		
		  const now = Date.now();
  if (needToSave && now - lastSaveTime > 5000 && gameUsername) {
    setPlayerScore(gameUsername, score);
    lastSaveTime = now;
    needToSave = false;
  }
  // =====================================
  
  if (Date.now() - lastTouchTime > 3000) {
    showIdlePrompt = true;
  } else {
    showIdlePrompt = false;
  }
  
  idlePulse = Math.sin(Date.now() / 500) * 0.3 + 0.7;
  
  if (showIdlePrompt) {
    ctx.font = "bold 36px sans-serif";
    ctx.textAlign = "center";
    ctx.lineWidth = 2;
    ctx.globalAlpha = idlePulse;

    ctx.strokeStyle = "white";
    ctx.strokeText("Tap to shoot", canvas.width / 2, canvas.height / 1.5);

    ctx.fillStyle = "white";
    ctx.fillText("Tap to shoot", canvas.width / 2, canvas.height / 1.5);

    ctx.globalAlpha = 1;
  }		
  requestAnimationFrame(draw);
  
  // =====================================
		
		if (Date.now() - lastTouchTime > 3000) {
		  showIdlePrompt = true;
		} else {
		  showIdlePrompt = false;
		}
		
		idlePulse = Math.sin(Date.now() / 500) * 0.3 + 0.7;
		
		if (showIdlePrompt) {
		  ctx.font = "bold 36px sans-serif";
		  ctx.textAlign = "center";
		  ctx.lineWidth = 2;
		  ctx.globalAlpha = idlePulse;

		  // –û–±–≤–æ–¥–∫–∞
		  ctx.strokeStyle = "white";
		  ctx.strokeText("Tap to shoot", canvas.width / 2, canvas.height / 1.5);

		  // –ó–∞–ª–∏–≤–∫–∞
		  ctx.fillStyle = "white";
		  ctx.fillText("Tap to shoot", canvas.width / 2, canvas.height / 1.5);

		  ctx.globalAlpha = 1;
		}		
        requestAnimationFrame(draw);
      }

      draw();
    };
  </script>
</body>
</html>
